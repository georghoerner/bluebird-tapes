#!/usr/bin/env node
/**
 * Generates a list of all unit display names from faction JSON files.
 * Output: frontend/src/utils/armyListParser/unitNames.txt
 *
 * Usage: node docs/tools/generateUnitNames.js
 */

import { readFileSync, writeFileSync, readdirSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const PROJECT_ROOT = join(__dirname, '../..');
// Primary location (has all 4 factions)
const FACTIONS_DIR = join(PROJECT_ROOT, 'frontend/src/data/factions');
const OUTPUT_FILE = join(PROJECT_ROOT, 'frontend/src/utils/armyListParser/unitNames.txt');

// Fallback location
const FACTIONS_DIR_ALT = join(PROJECT_ROOT, 'frontend/public/data/factions');

function loadFactionFiles(dir) {
  try {
    const files = readdirSync(dir).filter(f => f.endsWith('.json'));
    return files.map(f => ({
      path: join(dir, f),
      name: f.replace('.json', '')
    }));
  } catch (e) {
    return [];
  }
}

function extractUnitNames(factionFile) {
  try {
    const content = readFileSync(factionFile.path, 'utf8');
    const data = JSON.parse(content);

    if (!data.units || !Array.isArray(data.units)) {
      console.warn(`  Warning: No units array in ${factionFile.name}`);
      return [];
    }

    return data.units.map(unit => ({
      displayName: unit.displayName || unit.name,
      name: unit.name,
      id: unit.id,
      faction: data.factionName || factionFile.name,
      factionId: data.factionId || factionFile.name,
      points: unit.points,
      unitType: unit.unitType
    }));
  } catch (e) {
    console.error(`  Error reading ${factionFile.path}: ${e.message}`);
    return [];
  }
}

function main() {
  console.log('Generating unit names list...\n');

  // Try both directories
  let factionFiles = loadFactionFiles(FACTIONS_DIR);
  if (factionFiles.length === 0) {
    console.log(`No files in ${FACTIONS_DIR}, trying alternate...`);
    factionFiles = loadFactionFiles(FACTIONS_DIR_ALT);
  }

  if (factionFiles.length === 0) {
    console.error('No faction JSON files found!');
    process.exit(1);
  }

  console.log(`Found ${factionFiles.length} faction file(s):\n`);

  const allUnits = [];

  for (const factionFile of factionFiles) {
    console.log(`Processing: ${factionFile.name}`);
    const units = extractUnitNames(factionFile);
    console.log(`  Found ${units.length} units`);
    allUnits.push(...units);
  }

  // Sort by faction, then by name
  allUnits.sort((a, b) => {
    if (a.factionId !== b.factionId) return a.factionId.localeCompare(b.factionId);
    return a.displayName.localeCompare(b.displayName);
  });

  // Generate output
  const lines = [
    '# Unit Display Names',
    '# Generated by: node docs/tools/generateUnitNames.js',
    `# Generated at: ${new Date().toISOString()}`,
    `# Total units: ${allUnits.length}`,
    '',
    '# Format: DISPLAY_NAME | id | points | type | faction',
    '# ═══════════════════════════════════════════════════════════════════════',
    ''
  ];

  let currentFaction = '';
  for (const unit of allUnits) {
    if (unit.factionId !== currentFaction) {
      currentFaction = unit.factionId;
      lines.push(`\n# ─── ${unit.faction} ───`);
    }
    lines.push(`${unit.displayName} | ${unit.id} | ${unit.points} pts | ${unit.unitType} | ${unit.factionId}`);
  }

  // Also generate a simple list (just names)
  lines.push('\n\n# ═══════════════════════════════════════════════════════════════════════');
  lines.push('# SIMPLE LIST (display names only, for grammar reference)');
  lines.push('# ═══════════════════════════════════════════════════════════════════════\n');

  const uniqueNames = [...new Set(allUnits.map(u => u.displayName))].sort();
  lines.push(...uniqueNames);

  writeFileSync(OUTPUT_FILE, lines.join('\n'));

  console.log(`\n✓ Generated ${OUTPUT_FILE}`);
  console.log(`  Total units: ${allUnits.length}`);
  console.log(`  Unique names: ${uniqueNames.length}`);
}

main();
