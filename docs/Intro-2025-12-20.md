# Frontend Component Architecture Guide

**Date:** 2025-12-20

This document explains how the frontend components are organized and how they interact with each other.

---

## High-Level Overview

```
pages/Home.tsx
    │
    ├── Terminal (wrapper with CRT effects)
    │
    └── ArmyEditorLayout (3-column grid)
            │
            ├── Column 1: CodeMirrorEditor (text editor)
            │       │
            │       ├── Uses: armyListLanguage.ts (syntax highlighting)
            │       ├── Uses: pointsDecoration.ts (inline points calculation)
            │       ├── Uses: terminalTheme.ts (colors, cursor, decorations)
            │       ├── Uses: validation/* (unit name validation)
            │       └── Uses: TerminalDropdown.tsx (autocomplete popup)
            │
            ├── Column 2: UnitInfoPanel (unit stats display)
            │       │
            │       └── Uses: StatTooltip.tsx (hover explanations)
            │
            └── Column 3: AsciiArtPanel (unit image)
```

---

## Directory Structure

```
frontend/src/
├── components/
│   ├── ArmyEditor/           # Main editor components
│   │   ├── CodeMirrorEditor.tsx    # The text editor
│   │   ├── UnitInfoPanel.tsx       # Unit stats display
│   │   ├── AsciiArtPanel.tsx       # ASCII art display
│   │   ├── ArmyEditorLayout.tsx    # 3-column layout wrapper
│   │   ├── TerminalDropdown.tsx    # Autocomplete dropdown
│   │   ├── StatTooltip.tsx         # Hover tooltips for stats
│   │   ├── terminalTheme.ts        # CodeMirror theme & styles
│   │   ├── armyListLanguage.ts     # Lezer → CodeMirror syntax
│   │   ├── pointsDecoration.ts     # Inline points widget
│   │   ├── types.ts                # TypeScript interfaces
│   │   ├── index.ts                # Public exports
│   │   ├── ArmyTextEditor.tsx      # DEPRECATED (old textarea editor)
│   │   └── validation/             # Unit name validation
│   │       ├── validators.ts       # Core validation logic
│   │       ├── validationPlugin.ts # CodeMirror ViewPlugin
│   │       ├── validationTooltip.ts# Hover suggestions
│   │       ├── validationFacet.ts  # Faction data for CodeMirror
│   │       ├── fuzzyMatch.ts       # Levenshtein matching
│   │       └── types.ts            # Validation types
│   │
│   ├── Terminal/             # UI primitives (CRT aesthetic)
│   │   ├── Terminal.tsx      # Main wrapper with scanlines
│   │   ├── ExampleBlock.tsx  # Collapsible example army list
│   │   ├── CollapsibleSection.tsx
│   │   └── GridTooltip.tsx   # Hover explanations
│   │
│   └── ArmyForm/             # DEPRECATED (form-based editor)
│       └── ...
│
├── pages/
│   ├── Home.tsx              # Main page - assembles editor
│   ├── ViewList.tsx          # View shared army list
│   ├── Parser.tsx            # Parser testing page
│   └── AsciiGenerator.tsx    # ASCII art generator
│
├── hooks/
│   └── useFactionData.ts     # Loads faction JSON files
│
├── utils/
│   └── armyListParser/       # Lezer grammar & parser
│       ├── armyList.grammar  # Grammar definition
│       ├── buildParser.js    # Generates parser.js
│       ├── parser.js         # Generated parser (DO NOT EDIT)
│       ├── parser.terms.js   # Generated node types
│       └── testParser.js     # Parser tests
│
└── index.css                 # Global CSS & animations
```

---

## CodeMirror Files and Data Flow

### How Text Editor → Parser → Unit Info Works

```
User types in CodeMirrorEditor
        │
        ▼
EditorView.updateListener fires on every change
        │
        ├──► calculateStats() - walks parse tree for points
        │
        ├──► updateCursorUnit() - finds unit at cursor position
        │         │
        │         ▼
        │    Matches line against faction unit names
        │         │
        │         ▼
        │    Calls onCursorUnitChange(unit) prop
        │         │
        │         ▼
        │    Home.tsx receives unit → passes to UnitInfoPanel
        │
        └──► checkAutocomplete() - triggers dropdown
```

### Key CodeMirror Files

| File | Purpose |
|------|---------|
| `CodeMirrorEditor.tsx` | Main React component. Initializes EditorView, handles state, autocomplete, passes unit to parent. |
| `armyListLanguage.ts` | Connects Lezer parser to CodeMirror. Maps grammar node types (Header, Unit, Name) to highlight tags. |
| `terminalTheme.ts` | Visual styling: colors, cursor, selection, validation decorations, tooltip appearance. |
| `pointsDecoration.ts` | ViewPlugin that displays calculated points inline (e.g., "35/100 PTS"). |
| `validation/validationPlugin.ts` | ViewPlugin that decorates invalid unit names with wavy underlines. |
| `validation/validationTooltip.ts` | Shows fuzzy suggestions when hovering invalid units. |

### How Syntax Highlighting Works

```
armyList.grammar (Lezer grammar)
        │
        ▼ (buildParser.js)
parser.js (generated)
        │
        ▼ (imported by)
armyListLanguage.ts
        │
        ├── styleTags() maps node types to highlight tags:
        │     Header → tags.heading
        │     Name → tags.name
        │     Number → tags.number
        │     etc.
        │
        ▼
terminalTheme.ts
        │
        └── terminalHighlightStyle maps tags to CSS:
              tags.heading → amber with glow
              tags.name → inverted (dark on amber)
              tags.number → bright amber
```

---

## Unit Info Panel

### Location
`frontend/src/components/ArmyEditor/UnitInfoPanel.tsx`

### How It Gets Data
1. `CodeMirrorEditor` calls `onCursorUnitChange(unit)` when cursor moves
2. `Home.tsx` receives this via React state: `const [currentUnit, setCurrentUnit] = useState()`
3. `Home.tsx` passes unit to `<UnitInfoPanel unit={currentUnit} />`

### Structure
```tsx
UnitInfoPanel({ unit })
    ├── Header (font size controls)
    ├── Unit name & type & points
    ├── Stats one-liner (uses StatTooltip)
    ├── Abilities list
    ├── Description (if present)
    ├── Weapons list (recursive WeaponDisplay)
    └── Footer (section name)
```

### Related Files
| File | Purpose |
|------|---------|
| `UnitInfoPanel.tsx` | Main component |
| `StatTooltip.tsx` | Hover tooltips for stats (H, Q, T, etc.) |
| `types.ts` | Unit, Weapon, Stats interfaces |

---

## Where Animations Are Defined

### CSS Animations (index.css)

```css
/* Cursor blink */
@keyframes blink { ... }

/* CodeMirror cursor blink */
@keyframes cm-blink { ... }

/* Error blink (unknown units) - red flash */
@keyframes cm-error-blink {
  0%, 50% { color: #FF6B6B; }
  51%, 100% { color: #805800; }
}

/* Warning blink (cross-faction) - amber flash */
@keyframes cm-warning-blink {
  0%, 50% { background-color: rgba(255, 176, 0, 0.3); }
  51%, 100% { background-color: transparent; }
}
```

### CSS Classes That Use Animations

Defined in `terminalTheme.ts`:

```typescript
'.cm-validation-unknown': {
  textDecoration: 'underline wavy',
  animation: 'cm-error-blink 0.6s step-end infinite',
},
'.cm-validation-cross-faction': {
  animation: 'cm-warning-blink 0.8s step-end infinite',
},
```

### To Add New Animations

1. Define `@keyframes` in `frontend/src/index.css`
2. Create CSS class in `terminalTheme.ts` (inside EditorView.theme)
3. Apply class via CodeMirror decoration or React className

---

## Where to Put Code Suggestions

### Current Autocomplete (TerminalDropdown)

The existing autocomplete lives in `CodeMirrorEditor.tsx`:

```typescript
// Triggers
checkAutocomplete() - called on every document change
    ├── showFactionDropdown() - faction name suggestions
    ├── showUnitDropdown() - unit name suggestions
    └── showMountingModeDropdown() - [D], [E], [T] suggestions

// Display
<TerminalDropdown
  items={dropdownItems}
  selectedIndex={selectedIndex}
  onSelect={handleSelect}
  position={dropdownPosition}
  visible={dropdownVisible}
/>
```

### To Add New Suggestion Types

**Option A: Extend existing TerminalDropdown**

In `CodeMirrorEditor.tsx`:
1. Add detection logic in `checkAutocomplete()`
2. Create a new `showXxxDropdown()` function
3. Populate `dropdownItems` with your suggestions

**Option B: Use CodeMirror's built-in autocomplete**

```typescript
import { autocompletion, CompletionContext } from '@codemirror/autocomplete';

function myCompletions(context: CompletionContext) {
  // Return completion options
  return {
    from: context.pos,
    options: [
      { label: "suggestion1", type: "keyword" },
      { label: "suggestion2", type: "function" },
    ]
  };
}

// Add to extensions array:
autocompletion({ override: [myCompletions] })
```

**Option C: Validation-based suggestions (already implemented)**

For unknown units, hover tooltips already show suggestions via:
- `validation/fuzzyMatch.ts` - Levenshtein distance matching
- `validation/validationTooltip.ts` - Hover popup display

---

## Component Interaction Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│  Home.tsx                                                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ useFactionData() → { factions, getFactionData }             ││
│  │ [currentUnit, setCurrentUnit] = useState()                  ││
│  └─────────────────────────────────────────────────────────────┘│
│       │                    │                      │             │
│       ▼                    ▼                      ▼             │
│  ┌─────────────┐    ┌─────────────┐       ┌─────────────┐      │
│  │ CodeMirror  │    │ UnitInfo    │       │ AsciiArt    │      │
│  │ Editor      │───►│ Panel       │       │ Panel       │      │
│  │             │    │             │       │             │      │
│  │ Props:      │    │ Props:      │       │ Props:      │      │
│  │ - factions  │    │ - unit      │       │ - unit      │      │
│  │ - getFaction│    │             │       │             │      │
│  │ - onCursor  │    │             │       │             │      │
│  │   UnitChange│    │             │       │             │      │
│  └─────────────┘    └─────────────┘       └─────────────┘      │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ CodeMirror Extensions (inside EditorState)                  ││
│  │  ├── armyList() - syntax highlighting                       ││
│  │  ├── pointsDecorationPlugin - inline points                 ││
│  │  ├── validationPlugin - error decorations                   ││
│  │  ├── validationTooltip - hover suggestions                  ││
│  │  └── terminalTheme - visual styling                         ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## Quick Reference: What to Edit for Common Tasks

| Task | Files to Edit |
|------|---------------|
| Change editor colors | `terminalTheme.ts` |
| Add new syntax highlighting | `armyListLanguage.ts` + grammar |
| Add animation | `index.css` + `terminalTheme.ts` |
| Change Unit Info display | `UnitInfoPanel.tsx` |
| Add new autocomplete trigger | `CodeMirrorEditor.tsx` |
| Change validation rules | `validation/validators.ts` |
| Change fuzzy matching | `validation/fuzzyMatch.ts` |
| Add hover tooltip content | `validation/validationTooltip.ts` |
| Modify parser grammar | `armyList.grammar` → run `buildParser.js` |

---

## Files NOT to Edit Directly

| File | Reason |
|------|--------|
| `parser.js` | Generated by buildParser.js from grammar |
| `parser.terms.js` | Generated alongside parser.js |
| `ArmyTextEditor.tsx` | Deprecated, replaced by CodeMirrorEditor |
| `ArmyForm/*` | Deprecated form-based editor |
